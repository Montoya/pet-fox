<!doctype html>
<html>
  <head>
    <title>Pet Fox</title>
    <!-- link rel="icon" type="image/svg" href="./icon.svg"/ -->
    <style type="text/css">

body {
  margin:0;
  font-family: sans-serif;
}
p {
  font-size:18px;
  color:#333333;
}
a.btn { 
  color:#fff; 
  display:inline-block; 
  background-color:rgb(84,58,183); 
  background: linear-gradient(0deg, rgb(66, 58, 183) 0%, rgb(0, 129, 193) 100%);
  padding:12px; 
  border-radius:6px; 
  text-decoration:none;
}

.header {
  position:relative;
  text-align:center;
  background: linear-gradient(60deg, rgb(58, 73, 183) 0%, rgb(0, 148, 193) 100%);
  color:white;
}
.logo {
  width:64px;
  padding-right:15px;
  display:inline-block;
  vertical-align: middle;
}

.inner-header {
  height:40vh;
  width:100%;
  margin: 0;
  padding: 0;
}

.flex { /*Flexbox for containers*/
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
}

.waves {
  position:relative;
  width: 100%;
  height:15vh;
  margin-bottom:-7px; /*Fix for safari gap*/
  min-height:100px;
  max-height:150px;
}

.content {
  position:relative;
  height:20vh;
  text-align:center;
  background-color: #fff;
  padding-top:32px; 
}
.content p { 
  max-width:768px; 
}

/*Shrinking for mobile*/
@media (max-width: 768px) {
  .waves {
    height:40px;
    min-height:40px;
  }
  .content {
    height:30vh;
  }
  h1 {
    font-size:24px;
  }
}
    </style>
  </head>

  <body>

    <div class="header">

      <div class="inner-header flex">
        <h1>Pet Fox</h1>
      </div>
    
    </div>
    
    <!--Content starts-->
    <div class="content flex">
      <div id="installFlask" style="display:none">
        <p>Snaps is pre-release software only available in MetaMask Flask, a canary distribution for developers with access to upcoming features.</p>
        <a href="https://metamask.io/flask/" id="installFlaskButton" class="btn">
          Install MetaMask Flask
        </a>
      </div>
      <div id="installSnap">
        <a href="#" id="installSnapButton" class="btn">
          Connect and install Pet Fox snap
        </a>
      </div>
      <div id="snapInstalled" style="display:none">
        <p id="petFox">&nbsp;</p>
        <div id="buttons">
          <button id="feed">FEED</button> &nbsp; <button id="pet">PET</button>
        </div>
      </div>
    </div>
    <!--Content ends-->

    <script type="text/javascript">

const snapId = 'local:http://localhost:8080'; 

const isFlask = async () => {
  const provider = window.ethereum;

  try {
    const clientVersion = await provider?.request({
      method: 'web3_clientVersion',
    });

    const isFlaskDetected = (clientVersion)?.includes('flask');

    return provider && isFlaskDetected;
  } catch {
    return false;
  }
}; 

const getSnap = async () => {
  try {
    const snaps = await window.ethereum.request({
      method: 'wallet_getSnaps',
    }); 

    return Object.values(snaps).find(
      (snap) =>
        snap.id === snapId
    );
  } catch (e) {
    console.log('Failed to obtain installed snap', e);
    return undefined;
  }
};

const connectSnap = async (event) => {
  event.preventDefault(); 
  const provider = window.ethereum; 

  try { /*
    await provider?.request({
      method: 'wallet_requestSnaps', 
      params: 
        {
          [snapId]: { }
        },
    }); */

    const installedSnap = await getSnap();

    if(installedSnap) { 
      document.getElementById('installSnap').style.display = 'none'; 
      document.getElementById('snapInstalled').style.display = 'block'; 
      document.getElementById('feed').addEventListener('click',foxFeed); 
      document.getElementById('pet').addEventListener('click',foxPet); 
      run(); 
      setInterval(run, 1000); 
    }
  } catch { 

  }
  return false; 
}; 

const run = function() { 
  ethereum.request({
    method: 'wallet_invokeSnap',
    params: { 
      snapId: snapId, 
      request: { 
        method: 'update', 
      }
    } 
  }).then(function (fox) { 
    document.getElementById('petFox').textContent = JSON.stringify(fox); 
  }); 
}

const foxFeed = function() { 
  ethereum.request({
    method: 'wallet_invokeSnap',
    params: { 
      snapId: snapId, 
      request: { 
        method: 'feed', 
      }
    } 
  }); 
}

const foxPet = function() { 
  ethereum.request({
    method: 'wallet_invokeSnap',
    params: { 
      snapId: snapId, 
      request: { 
        method: 'pet', 
      }
    } 
  }); 
}

window.onload = async (event) => {
  const isFlaskDetected = await isFlask(); 
  if(!isFlaskDetected) {
    document.getElementById('installFlask').style.display = 'block'; 
    document.getElementById('installSnap').style.display = 'none'; 
    return; 
  }

  document.getElementById('installSnapButton').addEventListener('click', connectSnap); 
}; 
    </script>
  </body>
</html>